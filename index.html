<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul id="comments" class="comments"></ul>
      <div class="add-form">
        <input
          id="input"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="textarea"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="button" class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    'use strict'
    const now = new Date()
    const day = now.getDate().toString().padStart(2, '0')
    const month = (now.getMonth() + 1).toString().padStart(2, '0')
    const year = now.getFullYear().toString().slice(-2)
    const hours = now.getHours().toString().padStart(2, '0')
    const minutes = now.getMinutes().toString().padStart(2, '0')
    const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}`
    const listComments = document.getElementById('comments')
    const addFormText = document.querySelector('.add-form-text')
    const addFormButton = document.getElementById('button')

    let comments = []
    const dataComments = () => {
      fetch('https://wedev-api.sky.pro/api/v1/dmiriy-braun/comments', {
        method: 'GET',
      }).then((res) => {
        const jsonPromise = res.json().then((responseData) => {
          comments = responseData.comments
          renderComments()
        })
      })
    }

    listComments.addEventListener('click', function (event) {
      let target = event.target
      if (!target.classList.contains('comment-text')) {
        return
      }
      const currentHeader = document.querySelector(
        `[data-comment-header-index='${event.target.dataset.index}']`
      ) // нахожу определенный заголовок по дата атрибуту
      addFormText.value = `>${target.textContent.replace(/\s/g, ' ').trim()}\n${
        currentHeader.textContent
      }`
    })

    const likeButton = () => {
      listComments.addEventListener('click', function (event) {
        let target = event.target

        if (!target.classList.contains('like-button')) {
          return
        }
        console.log(target)

        const counter = document.querySelector(
          `[data-counter-index="${event.target.dataset.index}"]` //   нахожу счетчик с помощью дата атрибута по общему индексу
        )
        console.log(counter)
      })
    }
    // const initLikeButton = () => {
    //   const likes = document.querySelectorAll('.like-button')
    //   for (const likeButton of likes) {
    //     likeButton.addEventListener('click', function (e) {
    //       const likeindex = likeButton.dataset.index // нахожу значение атрибута лайк-кнопки по индексу массива

    //       const counter = document.querySelector(
    //         `[data-counter-index="${likeindex}"]` //   нахожу счетчик с помощью дата атрибута по общему индексу
    //       )
    //       const likeButtonEl = document.querySelector(
    //         `[data-index="${likeindex}"]`
    //       ) //   нахожу кнопку лайков с помощью дата атрибута по общему индексу

    //       const fixCount = comments[likeindex] // нужный объект по значению индекса дата-атрибута

    //       fixCount.isliked = fixCount.isliked ? false : true // меняю значения свойства isLike
    //       e.stopPropagation()
    //       renderComments()
    //     })
    //   }
    // }

    const renderComments = () => {
      console.log(comments)
      const commentsHTML = comments
        .map((comment, index) => {
          const inputDate = comment.date
          // 1. Преобразуем строку в объект Date, игнорируя часовой пояс:
          const date = new Date(inputDate.substring(0, 19))
          // 2. Форматируем дату в нужный формат:
          const formattedDate = `${date
            .getDate()
            .toString()
            .padStart(2, '0')}.${(date.getMonth() + 1)
            .toString()
            .padStart(2, '0')}.${date.getFullYear()} ${date
            .getHours()
            .toString()
            .padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`

          return `<li class="comment" data-idex="${comment.id}">
              <div class="comment-header">
                <div data-comment-header-index='${comment.id}'>${
            comment.author.name
          }</div>
                <div>${formattedDate}</div>
              </div>
              <div class="comment-body">
                <div class="comment-text" data-index="${comment.id}" >
                  ${comment.text}
                </div>
              </div>
              <div class="comment-footer">
                <div class="likes">
                  <span class="likes-counter" data-counter-index="${
                    comment.id
                  }">${comment.likes} </span>

                  <button class='${
                    comment.isliked ? 'like-button -active-like' : 'like-button'
                  }' data-index="${comment.id}"></button>

                </div>
              </div>
            </li>`
        })
        .join('')
      listComments.innerHTML = commentsHTML
    }

    addFormButton.addEventListener('click', function () {
      const inputValue = document
        .getElementById('input')
        .value.replaceAll('<', '&lt')
        .replaceAll('>', '&gt')
      const text = document
        .getElementById('textarea')
        .value.replaceAll('<', '&lt')
        .replaceAll('>', '&gt')
      if (text === '') {
        alert('Введите пожалуйста хоть что-нибудь')
        return
      }
      console.log(inputValue)
      console.log(text)

      fetch('https://wedev-api.sky.pro/api/v1/dmiriy-braun/comments', {
        method: 'POST',
        body: JSON.stringify({ text: text, name: inputValue }),
      }).then((res) => {
        res.json().then((responseData) => {
          console.log(responseData)
          console.log(comments)
        })
      })
      dataComments()
      renderComments()
    })

    dataComments()
    renderComments()
  </script>
</html>
