<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <div class="loading-comments-text">Комментарии загружаются...</div>
      <ul id="comments" class="comments"></ul>
      <p class="text-comment-loading">Комментарий загружается...</p>
      <div class="add-form">
        <input
          id="input"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="textarea"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="button" class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    'use strict'
    const listComments = document.getElementById('comments')
    const addFormText = document.querySelector('.add-form-text')
    const addFormButton = document.getElementById('button')

    let comments = []

    const dataComments = () => {
      fetch('https://wedev-api.sky.pro/api/v1/dmiriy-braun1/comments', {
        method: 'GET',
      }).then((res) => {
        res
          .json()
          .then((responseData) => {
            comments = responseData.comments
            renderComments()
          })
          .then(() => {
            const loadingCommentsText = document.querySelector(
              '.loading-comments-text'
            )
            loadingCommentsText.style.display = 'none'
          })
      })
    }

    listComments.addEventListener('click', function (event) {
      let target = event.target
      if (!target.classList.contains('comment-text')) {
        return
      }
      const currentHeader = document.querySelector(
        `[data-comment-header-index='${event.target.dataset.index}']`
      ) // нахожу определенный заголовок по дата атрибуту
      addFormText.value = `>${target.textContent.replace(/\s/g, ' ').trim()}\n${
        currentHeader.textContent
      }`
    })

    const likeButton = () => {
      listComments.addEventListener('click', function (event) {
        let target = event.target

        if (!target.classList.contains('like-button')) {
          return
        }
        console.log(target)

        const counter = document.querySelector(
          `[data-counter-index="${event.target.dataset.index}"]` //   нахожу счетчик с помощью дата атрибута по общему индексу
        )
        console.log(counter)
      })
    }

    const renderComments = () => {
      const commentsHTML = comments
        .map((comment) => {
          const inputDate = comment.date
          const date = new Date(inputDate.substring(0, 19))
          const formattedDate = `${date
            .getDate()
            .toString()
            .padStart(2, '0')}.${(date.getMonth() + 1)
            .toString()
            .padStart(2, '0')}.${date.getFullYear()} ${date
            .getHours()
            .toString()
            .padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`

          return `<li class="comment" data-idex="${comment.id}">
              <div class="comment-header">
                <div data-comment-header-index='${comment.id}'>${
            comment.author.name
          }</div>
                <div>${formattedDate}</div>
              </div>
              <div class="comment-body">
                <div class="comment-text" data-index="${comment.id}" >
                  ${comment.text}
                </div>
              </div>
              <div class="comment-footer">
                <div class="likes">
                  <span class="likes-counter" data-counter-index="${
                    comment.id
                  }">${comment.likes} </span>

                  <button class='${
                    comment.isliked ? 'like-button -active-like' : 'like-button'
                  }' data-index="${comment.id}"></button>

                </div>
              </div>
            </li>`
        })
        .join('')
      listComments.innerHTML = commentsHTML
    }

    addFormButton.addEventListener('click', function () {
      const inputValue = document
        .getElementById('input')
        .value.replaceAll('<', '&lt')
        .replaceAll('>', '&gt')
      const text = document
        .getElementById('textarea')
        .value.replaceAll('<', '&lt')
        .replaceAll('>', '&gt')
      if (text === '') {
        alert('Введите пожалуйста хоть что-нибудь')
        return
      }
      const newParagraph = document.querySelector('.text-comment-loading')
      document.querySelector('.add-form').style.display = 'none'
      newParagraph.style.display = 'flex'

      document
        .querySelector('.add-form')
        .parentNode.insertBefore(
          newParagraph,
          document.querySelector('.add-form')
        )

      fetch('https://wedev-api.sky.pro/api/v1/dmiriy-braun1/comments', {
        method: 'POST',
        body: JSON.stringify({ text: text, name: inputValue }),
      })
        .then((res) => {
          return res.json()
        })
        .then((resData) => {
          return fetch(
            'https://wedev-api.sky.pro/api/v1/dmiriy-braun1/comments',
            {
              method: 'GET',
            }
          )
        })
        .then((res) => {
          return res.json()
        })
        .then((res) => {
          comments = res.comments
          renderComments()
        })
        .then((data) => {
          document.querySelector('.add-form').style.display = 'flex'
          document.querySelector('.text-comment-loading').style.display = 'none'
        })
    })

    dataComments()
  </script>
</html>
